<%@ page contentType="text/html;charset=UTF-8" language="java" %><html><head>    <jsp:include page="../common/backend_common.jsp"/></head><body class="no-skin" youdao="bind" style="background: white"><input id="gritter-light" checked="" type="checkbox" class="ace ace-switch ace-switch-5" /><div class="page-header">    <h1>        用户管理        <small>            <i class="ace-icon fa fa-angle-double-right"></i>            维护部门与用户关系        </small>    </h1></div><div class="main-content-inner">    <div class="col-sm-3">        <div class="table-header">            部门列表&nbsp;&nbsp;            <a class="green" href="#" >                <i class="ace-icon fa fa-plus-circle orange bigger-130"></i>            </a>        </div>        <div id="deptList">        </div>    </div>    <div class="col-sm-9">        <div class="col-xs-12">            <div class="table-header">                用户列表&nbsp;&nbsp;                <a class="green" href="#" >                    <i class="ace-icon fa fa-plus-circle orange bigger-130"></i>                </a>            </div>            <div>                <div id="dynamic-table_wrapper" class="dataTables_wrapper form-inline no-footer">                    <div class="row">                        <div class="col-xs-6">                            <div class="dataTables_length" id="dynamic-table_length"><label>                                展示                                <select id="pageSize" name="dynamic-table_length" aria-controls="dynamic-table" class="form-control input-sm">                                    <option value="10">10</option>                                    <option value="25">25</option>                                    <option value="50">50</option>                                    <option value="100">100</option>                                </select> 条记录 </label>                            </div>                        </div>                        <div class="col-xs-6">                            <div id="dynamic-table_filter" class="dataTables_filter"><label>                                搜索:                                <input type="search" class="form-control input-sm" placeholder="" aria-controls="dynamic-table"></label></div>                        </div>                    </div>                    <table id="dynamic-table" class="table table-striped table-bordered table-hover dataTable no-footer" role="grid"                           aria-describedby="dynamic-table_info" style="font-size:14px">                        <thead>                        <tr role="row">                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                姓名                            </th>                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                所属部门                            </th>                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                邮箱                            </th>                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                电话                            </th>                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                状态                            </th>                            <th class="sorting_disabled" rowspan="1" colspan="1" aria-label=""></th>                        </tr>                        </thead>                        <tbody id="userList"></tbody>                    </table>                    <div class="row" id="userPage">                    </div>                </div>            </div>        </div>    </div></div><script id="paginateTemplate" type="x-tmpl-mustache"><div class="col-xs-6">    <div class="dataTables_info" id="dynamic-table_info" role="status" aria-live="polite">        总共 {{total}} 中的 {{from}} ~ {{to}}    </div></div><div class="col-xs-6">    <div class="dataTables_paginate paging_simple_numbers" id="dynamic-table_paginate">        <ul class="pagination">            <li class="paginate_button previous disabled" aria-controls="dynamic-table" tabindex="0" id="dynamic-table_previous">                <a href="#" >首页</a>            </li>            <li class="paginate_button " aria-controls="dynamic-table" tabindex="0">                <a href="#">前一页</a>            </li>            <li class="paginate_button active" aria-controls="dynamic-table" tabindex="0">                <a href="#" data-id="{{pageNo}}">第{{pageNo}}页</a>                <input type="hidden" id="pageNo" value="{{pageNo}}" />            </li>            <li class="paginate_button" aria-controls="dynamic-table" tabindex="0">                <a href="#">后一页</a>            </li>            <li class="paginate_button next" aria-controls="dynamic-table" tabindex="0" id="dynamic-table_next">                <a href="#">尾页</a>            </li>        </ul>    </div></div></script><script id="deptListTemplate" type="x-tmpl-mustache"><ol class="dd-list">    {{#deptList}}        <li class="dd-item dd2-item dept-name" id="dept_{{id}}" href="javascript:void(0)" data-id="{{id}}">            <div class="dd2-content" style="cursor:pointer;">            {{name}}            <span style="float:right;">                <a class="green dept-edit" href="#" data-id="{{id}}" >                    <i class="ace-icon fa fa-pencil bigger-100"></i>                </a>                &nbsp;                <a class="red dept-delete" href="#" data-id="{{id}}" data-name="{{name}}">                    <i class="ace-icon fa fa-trash-o bigger-100"></i>                </a>            </span>            </div>        </li>    {{/deptList}}</ol></script><script id="userListTemplate" type="x-tmpl-mustache">{{#userList}}<tr role="row" class="user-name odd" data-id="{{id}}"><!--even -->    <td><a href="#">{{username}}</a></td>    <td>{{deptId}}</td>    <td>{{mail}}</td>    <td>{{telephone}}</td>    <td>        <span class="label label-sm label-warning">{{status}}</span>    </td>    <td>        <div class="hidden-sm hidden-xs action-buttons">            <a class="green" href="#">                <i class="ace-icon fa fa-pencil bigger-100"></i>            </a>            <a class="red" href="#">                <i class="ace-icon fa fa-trash-o bigger-100"></i>            </a>            <a class="red" href="#">                <i class="ace-icon fa fa-flag bigger-100"></i>            </a>        </div>    </td></tr>{{/userList}}</script><script type="text/javascript" src="/js/jquery-1.7.2.min.js"></script><script type="text/javascript" src="/assets/js/jquery.gritter.min.js"></script><script type="text/javascript" src="http://cdn.bootcss.com/mustache.js/2.2.1/mustache.js"></script><script type="text/javascript">    $(function () {        var lastClickDeptId = -1;        // 预编译需要使用的模板        var deptListTemplate = $('#deptListTemplate').html();        Mustache.parse(deptListTemplate);        var userListTemplate = $('#userListTemplate').html();        Mustache.parse(userListTemplate);        var paginateTemplate = $('#paginateTemplate').html();        Mustache.parse(paginateTemplate);        loadDeptList();        // 加载部门列表        function loadDeptList() {            $.ajax({                url: "/sys/dept/tree.json",                success: function (result) {                    if (result.ret) {                        var rendered = Mustache.render(deptListTemplate, {deptList: result.data});                        $('#deptList').html(rendered);                        recursiveRenderDept(result.data);                        bindDeptClick();                    } else {                        $('#deptList').html(result.msg);                    }                }            });        }        // 递归渲染部门列表        function recursiveRenderDept(deptList) {            if (deptList && deptList.length > 0) {                $(deptList).each(function (i, dept) {                    if (dept.deptList.length > 0) {                        var rendered = Mustache.render(deptListTemplate, {deptList: dept.deptList});                        $('#dept_' + dept.id).append(rendered);                        recursiveRenderDept(dept.deptList);                    }                });            }        }        // 点击部门名称        function bindDeptClick() {            $(".dept-name").click(function (e) {                e.preventDefault();                e.stopPropagation(); // 此处必须要取消冒泡,因为是个递归结构,冒泡的话会让一个点击被响应多个                var deptId = $(this).attr("data-id");                if (deptId != lastClickDeptId) {                    handleDeptSelected(deptId);                }            });            $(".dept-edit").click(function (e) {                e.preventDefault();                e.stopPropagation(); // 此处必须要取消冒泡,因为是个递归结构,冒泡的话会让一个点击被响应多个                var deptId = $(this).attr("data-id");            });            $(".dept-delete").click(function (e) {                e.preventDefault();                e.stopPropagation(); // 此处必须要取消冒泡,因为是个递归结构,冒泡的话会让一个点击被响应多个                var deptId = $(this).attr("data-id");                var deptName = $(this).attr("data-name");                if(confirm("确定要删除部门[" + deptName + "]吗?")) {                    $.ajax({                        url: "/sys/dept/delete.json",                        data: {                            id: deptId                        },                        success: function(result){                            if(result.ret) {                                showMessage("删除部门[" + deptName + "]", "操作成功", true);                            } else {                                showMessage("删除部门[" + deptName + "]", result.msg, false);                            }                        }                    });                }            });        }        // 选中一个部门        function handleDeptSelected(deptId) {            if (lastClickDeptId != -1) {                var lastDept = $("#dept_" + lastClickDeptId + " .dd2-content:first");                lastDept.removeClass("btn-yellow");                lastDept.removeClass("no-hover");            }            var currentDept = $("#dept_" + deptId + " .dd2-content:first");            currentDept.addClass("btn-yellow");            currentDept.addClass("no-hover");            lastClickDeptId = deptId;            loadUserList(deptId);        }        // 加载部门下用户信息,并渲染        function loadUserList(deptId) {            var pageSize = $("#pageSize").val();            var pageNo = $("#pageNo").val() | 1;            $.ajax({                url: "/sys/user/list.json",                data: {                    deptId: deptId,                    pageSize: pageSize,                    pageNo: pageNo                },                success: function (result) {                    if (result.ret) {                        var rendered = Mustache.render(userListTemplate, {userList: result.data.data});                        $('#userList').html(rendered);                        var total = result.data.total;                        var from = (pageNo - 1) * pageSize + 1;                        var view = {                            total: total,                            pageNo: pageNo,                            from: from > total ? total : from,                            to: (from + pageSize) > total ? total : (from + pageSize)                        };                        $("#userPage").html(Mustache.render(paginateTemplate, view));                    } else {                        showMessage("获取部门下用户列表", result.msg, false);                    }                }            });        }        function showMessage(title, message, isSuccess) {            $.gritter.add({                title: title,                text: message,                time: '',                class_name: (isSuccess ?'gritter-success':'gritter-warning') + (!$('#gritter-light').get(0).checked ? ' gritter-light' : '')            });        }    });</script></body></html>