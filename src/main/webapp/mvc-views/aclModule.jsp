<%@ page contentType="text/html;charset=UTF-8" language="java" %><html><head>    <title>权限管理</title>    <jsp:include page="../common/backend_common.jsp"/>    <jsp:include page="../common/page.jsp"/></head><body class="no-skin" youdao="bind" style="background: white"><input id="gritter-light" checked="" type="checkbox" class="ace ace-switch ace-switch-5"/><div class="page-header">    <h1>        权限模块管理        <small>            <i class="ace-icon fa fa-angle-double-right"></i>            维护权限模块和权限点关系        </small>    </h1></div><div class="main-content-inner">    <div class="col-sm-3">        <div class="table-header">            权限模块列表&nbsp;&nbsp;            <a class="green" href="#">                <i class="ace-icon fa fa-plus-circle orange bigger-130 acl-module-add"></i>            </a>        </div>        <div id="aclModuleList">        </div>    </div>    <div class="col-sm-9">        <div class="col-xs-12">            <div class="table-header">                权限点列表&nbsp;&nbsp;                <a class="green" href="#">                    <i class="ace-icon fa fa-plus-circle orange bigger-130 user-add"></i>                </a>            </div>            <div>                <div id="dynamic-table_wrapper" class="dataTables_wrapper form-inline no-footer">                    <div class="row">                        <div class="col-xs-6">                            <div class="dataTables_length" id="dynamic-table_length"><label>                                展示                                <select id="pageSize" name="dynamic-table_length" aria-controls="dynamic-table" class="form-control input-sm">                                    <option value="10">10</option>                                    <option value="25">25</option>                                    <option value="50">50</option>                                    <option value="100">100</option>                                </select> 条记录 </label>                            </div>                        </div>                        <div class="col-xs-6">                            <div id="dynamic-table_filter" class="dataTables_filter"><label>                                搜索:                                <input type="search" class="form-control input-sm" placeholder="" aria-controls="dynamic-table"></label></div>                        </div>                    </div>                    <table id="dynamic-table" class="table table-striped table-bordered table-hover dataTable no-footer" role="grid"                           aria-describedby="dynamic-table_info" style="font-size:14px">                        <thead>                        <tr role="row">                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                权限名称                            </th>                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                权限模块                            </th>                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                类型                            </th>                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                URL                            </th>                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                状态                            </th>                            <th tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1">                                顺序                            </th>                            <th class="sorting_disabled" rowspan="1" colspan="1" aria-label=""></th>                        </tr>                        </thead>                        <tbody id="aclList"></tbody>                    </table>                    <div class="row" id="aclPage">                    </div>                </div>            </div>        </div>    </div></div><script id="aclModuleListTemplate" type="x-tmpl-mustache"><ol class="dd-list">    {{#aclModuleList}}        <li class="dd-item dd2-item aclModule-name" id="aclModule_{{id}}" href="javascript:void(0)" data-id="{{id}}">            <div class="dd2-content" style="cursor:pointer;">            {{name}}            <span style="float:right;">                <a class="green dept-edit" href="#" data-id="{{id}}" >                    <i class="ace-icon fa fa-pencil bigger-100"></i>                </a>                &nbsp;                <a class="red dept-delete" href="#" data-id="{{id}}" data-name="{{name}}">                    <i class="ace-icon fa fa-trash-o bigger-100"></i>                </a>            </span>            </div>        </li>    {{/aclModuleList}}</ol></script><script id="aclListTemplate" type="x-tmpl-mustache">{{#aclList}}<tr role="row" class="acl-name odd" data-id="{{id}}"><!--even -->    <td><a href="#" class="acl-edit" data-id="{{id}}">{{name}}</a></td>    <td>{{showAclModuleName}}</td>    <td>{{showType}}</td>    <td>{{url}}</td>    <td>{{#bold}}{{showStatus}}{{/bold}}</td>    <td>{{seq}}</td>    <td>        <div class="hidden-sm hidden-xs action-buttons">            <a class="green acl-edit" href="#" data-id="{{id}}">                <i class="ace-icon fa fa-pencil bigger-100"></i>            </a>            <a class="red acl-history" href="#" data-id="{{id}}">                <i class="ace-icon fa fa-flag bigger-100"></i>            </a>        </div>    </td></tr>{{/aclList}}</script><script type="text/javascript">    $(function(){        var aclModuleList; // 存储树形权限模块列表        var aclModuleMap = {}; // 存储map格式权限模块列表        var aclMap = {}; // 存储map格式的权限点列表        var optionStr = ""; // 用于存储最新的权限模块列表组成的下拉列表字符串, 每次使用前清为空串        var lastAclModuleId = -1;        // 预编译需要使用的模板        var aclModuleListTemplate = $('#aclModuleListTemplate').html();        Mustache.parse(aclModuleListTemplate);        var aclListTemplate = $('#aclListTemplate').html();        Mustache.parse(aclListTemplate);        // 加载部门列表        loadAclModuleList();        function loadAclModuleList() {            $.ajax({                url: "/sys/aclModule/tree.json",                success: function (result) {                    if (result.ret) {                        aclModuleList = result.data;                        var rendered = Mustache.render(aclModuleListTemplate, {aclModuleList: result.data});                        $('#aclModuleList').html(rendered);                        recursiveRenderAclModule(result.data);                        bindAclModuleClick();                    } else {                        showMessage("加载权限模块列表", result.msg, false);                    }                }            });        }        // 递归渲染权限模块列表        function recursiveRenderAclModule(aclModuleList) {            if (aclModuleList && aclModuleList.length > 0) {                $(aclModuleList).each(function (i, aclModule) {                    aclModuleMap[aclModule.id] = aclModule;                    if (aclModule.aclModuleList && aclModule.aclModuleList.length > 0) {                        var rendered = Mustache.render(aclModuleListTemplate, {aclModuleList: aclModule.aclModuleList});                        $('#aclModule_' + aclModule.id).append(rendered);                        recursiveRenderAclModule(aclModule.aclModuleList);                    }                });            }        }        function bindAclModuleClick() {            $(".aclModule-name").click(function (e) {                e.preventDefault();                e.stopPropagation(); // 此处必须要取消冒泡,因为是个递归结构,冒泡的话会让一个点击被响应多个                loadAclList($(this).attr("data-id"));            });            // 处理点击选中            $(".aclModule-name").click(function (e) {                e.preventDefault();                e.stopPropagation(); // 此处必须要取消冒泡,因为是个递归结构,冒泡的话会让一个点击被响应多个                var aclModuleId = $(this).attr("data-id");                if (aclModuleId != lastAclModuleId) {                    handleAclModuleSelected(aclModuleId);                }            });        }        // 选中一个权限模块, 加载样式, 并加载对应权限点的列表并渲染        function handleAclModuleSelected(aclModuleId) {            if (lastAclModuleId != -1) {                var lastAclModule = $("#aclModule_" + lastAclModuleId + " .dd2-content:first");                lastAclModule.removeClass("btn-yellow");                lastAclModule.removeClass("no-hover");            }            var currentAclModule = $("#aclModule_" + aclModuleId + " .dd2-content:first");            currentAclModule.addClass("btn-yellow");            currentAclModule.addClass("no-hover");            lastAclModuleId = aclModuleId;            loadAclList(aclModuleId);        }        // 加载权限模块下权限信息,并渲染        function loadAclList(aclModuleId) {            var pageSize = $("#pageSize").val();            var url = "/sys/acl/list.json?aclModuleId=" + aclModuleId;            $("#aclPage .pageNo").val(1);            $.ajax({                url: url,                data: {                    pageSize: pageSize,                    pageNo: 1                },                success: function (result) {                    renderAclListAndPage(result, url);                }            });        }        function renderAclListAndPage(result, url) {            if (result.ret) {                if (result.data.total > 0) {                    var rendered = Mustache.render(aclListTemplate, {                        "aclList": result.data.data,                        "showAclModuleName": function () {                            return aclModuleMap[this.aclModuleId].name;                        },                        "showStatus": function () {                            return this.status == 1 ? "有效" : (this.status == 0 ? "无效" : "删除");                        },                        "showType": function() {                            return this.type == 0 ? "菜单" : (this.type == 1 ? "按钮" : "其他");                        },                        "bold": function () { // 对展示做特殊处理                            return function (text, render) {                                var status = render(text); // 获取出渲染后的值                                if (status == '有效') {                                    return "<span class='label label-sm label-success'>有效</span>";                                } else if (status == '无效') {                                    return "<span class='label label-sm label-warning'>无效</span>";                                } else {                                    return "<span class='label'>删除</span>";                                }                            }                        }                    });                    $('#aclList').html(rendered);                    bindAclClick();                    $.each(result.data.data, function (i, acl) {                        aclMap[acl.id] = acl;                    });                } else {                    $('#aclList').html('');                }                var pageSize = $("#pageSize").val();                var pageNo = $("#aclPage .pageNo").val() || 1;                renderPage(url, result.data.total, pageNo, pageSize, result.data.total > 0 ? result.data.data.length : 0, "aclPage", renderAclListAndPage);            } else {                showMessage("获取权限模块下权限点列表", result.msg, false);            }        }        // 绑定权限点相关点击事件        function bindAclClick() {            // 处理点击[编辑权限点]按钮            $(".acl-edit").click(function (e) {                e.preventDefault();                e.stopPropagation(); // 此处必须要取消冒泡,因为是个递归结构,冒泡的话会让一个点击被响应多个                var aclId = $(this).attr("data-id"); // 选中的权限点id                alert(aclId);            });        }    });</script></body></html>